<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Galaxy Runner — Fixed & Improved</title>
  <style>
    :root{--w:900;--h:600}
    html,body{height:100%;margin:0}
    body{display:flex;align-items:center;justify-content:center;background:#05060a;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{position:relative;width:var(--w)px;height:var(--h)px;box-shadow:0 10px 40px rgba(0,0,0,0.6);border-radius:10px;overflow:hidden}
    canvas{display:block;width:100%;height:100%;background:linear-gradient(180deg,#001018,#000)}
    #ui{position:absolute;top:12px;left:12px;z-index:10;display:flex;gap:12px;font-weight:600}
    #startBtn{position:absolute;right:12px;bottom:12px;z-index:10;padding:10px 14px;border-radius:8px;border:none;background:#0ea5a6;color:#022;cursor:pointer;font-weight:700}
    #msg{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9;background:rgba(0,0,0,0.6);padding:14px 18px;border-radius:10px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="ui">
      <div>Score: <span id="score">0</span></div>
      <div>Health: <span id="health">100</span></div>
      <div>Level: <span id="level">1</span></div>
    </div>

    <div id="msg" aria-live="polite">Press <strong>Start</strong> or Space to begin</div>
    <button id="startBtn">Start</button>
    <canvas id="game" width="900" height="600" aria-label="Galaxy Runner"></canvas>
  </div>

  <script>
    // Improved and more robust version with fixes
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const dpr = Math.min(window.devicePixelRatio || 1, 2);
    const CSS_WIDTH = canvas.width;
    const CSS_HEIGHT = canvas.height;
    canvas.width = Math.round(CSS_WIDTH * dpr);
    canvas.height = Math.round(CSS_HEIGHT * dpr);
    ctx.scale(dpr, dpr);

    const scoreEl = document.getElementById('score');
    const healthEl = document.getElementById('health');
    const levelEl = document.getElementById('level');
    const startBtn = document.getElementById('startBtn');
    const msg = document.getElementById('msg');

    let running = false;
    let score = 0;
    let health = 100;
    let level = 1;

    const groundY = 520; // fixed ground line (in CSS pixels)

    const player = {x:100,y:groundY - 40,w:40,h:40,dy:0,jumping:false};
    const gravity = 0.6;

    const obstacles = [];
    const stars = [];

    // Utility
    function rand(min,max){ return Math.random()*(max-min)+min }

    function spawnStar(){
      stars.push({x:CSS_WIDTH + 10, y: rand(10, groundY - 40), w: 1 + Math.random()*2, speed: 1 + Math.random()*2});
    }
    function spawnObstacle(){
      const size = 30 + Math.random()*30;
      obstacles.push({x:CSS_WIDTH + 10, y: groundY - size, w: size, h: size, speed: 4 + level*0.6 + Math.random()*1.5});
    }

    function drawGround(){
      ctx.fillStyle = '#072022';
      ctx.fillRect(0, groundY, CSS_WIDTH, CSS_HEIGHT - groundY);
      // subtle line
      ctx.fillStyle = '#0b3140';
      ctx.fillRect(0, groundY - 2, CSS_WIDTH, 2);
    }

    function drawPlayer(){
      ctx.fillStyle = '#39f7ff';
      roundRect(ctx, player.x, player.y, player.w, player.h, 6, true, false);
      // simple thruster when jumping
      if(player.jumping){
        ctx.fillStyle = 'rgba(255,200,80,0.12)';
        ctx.fillRect(player.x + 8, player.y + player.h, player.w - 16, 10);
      }
    }

    function drawObstacles(){
      ctx.fillStyle = '#ff6b6b';
      obstacles.forEach(o => roundRect(ctx, o.x, o.y, o.w, o.h, 6, true, false));
    }
    function drawStars(){
      ctx.fillStyle = '#fff';
      stars.forEach(s => ctx.fillRect(s.x, s.y, s.w, s.w));
    }

    function updatePlayer(){
      player.dy += gravity;
      player.y += player.dy;
      if(player.y + player.h > groundY){ player.y = groundY - player.h; player.dy = 0; player.jumping = false; }
    }

    function updateObstacles(){
      for(const o of obstacles) o.x -= o.speed;
      for(let i=obstacles.length-1;i>=0;i--){ if(obstacles[i].x + obstacles[i].w < -20) { obstacles.splice(i,1); score += 10; scoreEl.textContent = score; } }
    }

    function updateStars(){
      for(const s of stars) s.x -= s.speed;
      for(let i=stars.length-1;i>=0;i--){ if(stars[i].x < -10) stars.splice(i,1); }
    }

    function checkCollision(){
      for(let i=obstacles.length-1;i>=0;i--){
        const o = obstacles[i];
        if(player.x < o.x + o.w && player.x + player.w > o.x && player.y < o.y + o.h && player.y + player.h > o.y){
          // collision occurred
          obstacles.splice(i,1);
          health -= 20;
          healthEl.textContent = health;
          // quick feedback
          flashScreen();
          if(health <= 0){ endGame(); }
        }
      }
    }

    function levelUp(){
      if(score >= level * 200){ level++; levelEl.textContent = level; showMessage('Level ' + level); }
    }

    // small screen flash on hit
    let flashAlpha = 0;
    function flashScreen(){ flashAlpha = 0.6; }

    function gameLoop(){
      if(!running) return;
      ctx.clearRect(0,0,CSS_WIDTH,CSS_HEIGHT);

      // background stars
      drawStars();

      // ground & objects
      drawGround();
      drawObstacles();
      drawPlayer();

      // updates
      updateStars();
      updateObstacles();
      updatePlayer();
      checkCollision();
      levelUp();

      // spawn probabilities (more reliable than tiny random values)
      if(Math.random() < 0.15) spawnStar();
      if(Math.random() < 0.02 + level*0.01) spawnObstacle();

      // flash overlay when hit
      if(flashAlpha > 0){
        ctx.fillStyle = 'rgba(255,40,40,' + flashAlpha + ')';
        ctx.fillRect(0,0,CSS_WIDTH,CSS_HEIGHT);
        flashAlpha *= 0.85;
      }

      requestAnimationFrame(gameLoop);
    }

    function startGame(){
      if(running) return;
      running = true;
      score = 0; health = 100; level = 1;
      scoreEl.textContent = score; healthEl.textContent = health; levelEl.textContent = level;
      obstacles.length = 0; stars.length = 0;
      msg.style.display = 'none';
      startBtn.textContent = 'Restart';
      gameLoop();
    }

    function endGame(){
      running = false;
      showMessage('Game Over — Score: ' + score);
      startBtn.textContent = 'Start';
    }

    function showMessage(text){ msg.innerHTML = text; msg.style.display = 'block'; setTimeout(()=>{ if(running) msg.style.display='none' }, 1600); }

    // helper: rounded rectangle
    function roundRect(ctx, x, y, w, h, r, fill, stroke){
      if(typeof r === 'number') r = {tl:r, tr:r, br:r, bl:r};
      ctx.beginPath();
      ctx.moveTo(x + r.tl, y);
      ctx.lineTo(x + w - r.tr, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
      ctx.lineTo(x + w, y + h - r.br);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
      ctx.lineTo(x + r.bl, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
      ctx.lineTo(x, y + r.tl);
      ctx.quadraticCurveTo(x, y, x + r.tl, y);
      ctx.closePath();
      if(fill) ctx.fill();
      if(stroke) ctx.stroke();
    }

    // Controls
    document.addEventListener('keydown', e => {
      if(e.code === 'Space' || e.code === 'ArrowUp'){
        e.preventDefault();
        if(!running) startGame();
        if(!player.jumping){ player.dy = -11; player.jumping = true; }
      }
    });

    // mobile / click
    canvas.addEventListener('pointerdown', e => {
      if(!running) startGame();
      if(!player.jumping){ player.dy = -11; player.jumping = true; }
    });

    startBtn.addEventListener('click', startGame);

    // initial message
    msg.style.display = 'block';

    // expose for debugging (optional)
    window._game = { startGame, endGame, obstacles, stars };
  </script>
</body>
</html>
